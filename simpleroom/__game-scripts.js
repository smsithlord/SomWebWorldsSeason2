var SomSim=pc.createScript("somSim");SomSim.prototype.initialize=function(){var t=this.app;t.hasOwnProperty("som")||(t.som=this,this.isSomnium=!1,this.player=null,this.playerInputFrozen=!1)},SomSim.prototype.postInitialize=function(){if(!this.app.som.isSomnium){this.player=this.entity.parent.findByName("LocalPlayerSimulator"),this.player.enabled=!0;var t=this.app.root.children[0].findByTag("playerspawn");if(t.length>0){var i=t[Math.floor(Math.random()*t.length)];this.player.rigidbody.teleport(i.getPosition().clone(),i.getEulerAngles().clone())}setTimeout(function(){this.app.som.fire("player:joinWorld")}.bind(this),1e3)}},SomSim.prototype.webWorldInit=function(t){return new Promise(function(i,e){this.entity.findByName("Augment Platform Prefab").enabled=0!=t.type,i({success:!0})}.bind(this))},SomSim.prototype.setPlayerInputFrozen=function(t){this.playerInputFrozen=t};var SomWebWorld=pc.createScript("_som_webWorld");SomWebWorld.attributes.add("type",{title:"World Type",description:"Control how visitors load into your world. Augment Worlds get ADDED to the regular parcel build. Holistic Worlds REPLACE the regular parcel build.",type:"number",enum:[{"Holistic World":0},{"Augment World":1}],default:0}),SomWebWorld.attributes.add("allowedParcels",{title:"Allowed Parcels",type:"number",array:!0,description:"Explicitly list which PARCEL IDs that Somnium Space Web is allowed to use this world on. Leave blank to allow ANY parcel to use this world."}),SomWebWorld.attributes.add("sdkVersion",{title:"SDK Version",type:"number",enum:[{"v0-1-2":2}],default:2}),SomWebWorld.prototype.postInitialize=function(){var e,l={id:this.id,title:this.title,url:this.url,type:this.type,allowEverywhere:this.allowEverywhere,allowedParcels:this.allowedParcels,worldMixing:this.worldMixing,mixWorlds:this.mixWorlds,apiVersion:this.apiVersion};if(this.app.som.isSomnium){e=this.app.root.children[0].findByTag("disableIfSom");for(o=0;o<e.length;o++)e[o].enabled=!1;e=this.app.root.children[0].findByTag("enableIfSom");for(o=0;o<e.length;o++)e[o].enabled=!0}else{e=this.app.root.children[0].findByTag("disableIfNotSom");for(var o=0;o<e.length;o++)e[o].enabled=!1;e=this.app.root.children[0].findByTag("enableIfNotSom");for(var o=0;o<e.length;o++)e[o].enabled=!0}this.app.som.webWorldInit(l).then((e=>{e.success?console.log("Web World Initialized"):console.log(e.errorMessage)}))};var PlayerMovement=pc.createScript("playerMovement");PlayerMovement.attributes.add("speed",{type:"number",default:.09}),PlayerMovement.prototype.initialize=function(){var e=this.app.root.findByName("Camera");this.cameraScript=e.script.cameraMovement},PlayerMovement.worldDirection=new pc.Vec3,PlayerMovement.tempDirection=new pc.Vec3,PlayerMovement.prototype.update=function(e){var t=this.app,r=PlayerMovement.worldDirection;r.set(0,0,0);var i=PlayerMovement.tempDirection,a=this.entity.forward,o=this.entity.right,n=0,p=0;if(!this.app.som.playerInputFrozen&&(t.keyboard.isPressed(pc.KEY_A)&&(n-=1),t.keyboard.isPressed(pc.KEY_D)&&(n+=1),t.keyboard.isPressed(pc.KEY_W)&&(p+=1),t.keyboard.isPressed(pc.KEY_S)&&(p-=1),0!==n||0!==p)){r.add(i.copy(a).mulScalar(p)),r.add(i.copy(o).mulScalar(n)),r.normalize();var s=new pc.Vec3(r.x*e,0,r.z*e);s.normalize().scale(this.speed),s.add(this.entity.getPosition());var c=this.cameraScript.eulers.x+180,y=new pc.Vec3(0,c,0);this.entity.rigidbody.teleport(s,y)}this.entity.anim.setFloat("xDirection",n),this.entity.anim.setFloat("zDirection",p)};var CameraMovement=pc.createScript("cameraMovement");CameraMovement.attributes.add("mouseSpeed",{type:"number",default:1.4,description:"Mouse Sensitivity"}),CameraMovement.prototype.initialize=function(){this.eulers=new pc.Vec3,this.touchCoords=new pc.Vec2,this.cameraInputDown=!1;var e=this.app;e.mouse.on("mousemove",this.onMouseMove,this),e.mouse.on("mousedown",this.onMouseDown,this),e.mouse.on("mouseup",this.onMouseUp,this),this.rayEnd=e.root.findByName("RaycastEndPoint"),this.on("destroy",(function(){e.mouse.off("mousemove",this.onMouseMove,this),e.mouse.off("mousedown",this.onMouseDown,this),e.mouse.off("mouseup",this.onMouseUp,this)}),this)},CameraMovement.prototype.postUpdate=function(e){if(!this.app.som.playerInputFrozen){var t=this.entity.parent,o=this.eulers.x+180,s=this.eulers.y,n=new pc.Vec3(-s,o,0);t.setEulerAngles(n),this.entity.setPosition(this.getWorldPoint()),this.entity.lookAt(t.getPosition())}},CameraMovement.prototype.onMouseMove=function(e){this.app.som.playerInputFrozen||(pc.Mouse.isPointerLocked()||this.cameraInputDown)&&(this.eulers.x-=this.mouseSpeed*e.dx/60%360,this.eulers.y+=this.mouseSpeed*e.dy/60%360,this.eulers.x<0&&(this.eulers.x+=360),this.eulers.y<0&&(this.eulers.y+=360))},CameraMovement.prototype.onMouseDown=function(e){this.app.som.playerInputFrozen||(this.cameraInputDown=!0)},CameraMovement.prototype.onMouseUp=function(e){this.app.som.playerInputFrozen||(this.cameraInputDown=!1)},CameraMovement.prototype.getWorldPoint=function(){var e=this.entity.parent.getPosition(),t=this.rayEnd.getPosition(),o=this.app.systems.rigidbody.raycastFirst(e,t);return o?o.point:t};var SomWebBrowser=pc.createScript("_som_webBrowser");SomWebBrowser.attributes.add("url",{type:"string",title:"URL",description:"URL to bind to this entity's model."}),SomWebBrowser.attributes.add("resolution",{type:"number",title:"Resolution",enum:[{Auto:0},{Low:1},{Medium:2},{High:3}],default:0,description:"Control the resolution scale of the web browser object."}),SomWebBrowser.attributes.add("autoPlay",{type:"boolean",title:"AutoPlay",default:!1,description:"Automatically activates this web browser object upon spawning into the world."}),SomWebBrowser.attributes.add("description",{type:"string",title:"UI Text",description:"Optional. The text to show on the menu when the user clicks on the object."}),SomWebBrowser.attributes.add("thumbnail",{type:"asset",title:"UI Thumbnail",assetType:"texture",description:"Appears in the menu when the user clicks on the object."}),SomWebBrowser.attributes.add("buttonGo",{type:"boolean",title:"UI Btn Go",default:!1,description:"Opens link in same window."}),SomWebBrowser.attributes.add("buttonNewTab",{type:"boolean",title:"UI Btn New Tab",default:!0,description:"Opens link in new window."}),SomWebBrowser.attributes.add("buttonInWorld",{type:"boolean",title:"UI Btn In-World",default:!0,description:"Opens link in-world."}),SomWebBrowser.prototype.initialize=function(){};var SomTexScrollManager=pc.createScript("_som_texScrollManager");SomTexScrollManager.attributes.add("materials",{title:"Materials to Scroll",type:"json",schema:[{title:"Material Asset",name:"material",type:"asset",assetType:"material"},{title:"Speed",name:"speed",type:"vec2"},{title:"Diffuse",name:"diffuse",type:"boolean",default:!0},{title:"Normal",name:"normal",type:"boolean",default:!1},{title:"Emissive",name:"emissive",type:"boolean",default:!1},{title:"Opacity",name:"opacity",type:"boolean",default:!1}],array:!0}),SomTexScrollManager.tmpVec2=new pc.Vec2,SomTexScrollManager.tmpOffset=new pc.Vec2,SomTexScrollManager.prototype.initialize=function(){},SomTexScrollManager.prototype.update=function(e){let a,t,l,o,r,s,i=SomTexScrollManager.tmpVec2,p=SomTexScrollManager.tmpOffset;for(let m=0;m<this.materials.length;m++)if(a=this.materials[m],t=a.material&&a.material.resource?a.material.resource:null,t){for(i.set(a.speed.x,a.speed.y),i.scale(e),l=[],a.diffuse&&l.push("diffuseMapOffset"),a.normal&&l.push("normalMapOffset"),a.emissive&&l.push("emissiveMapOffset"),a.opacity&&l.push("opacityMapOffset"),s=!1,o=0;o<l.length;o++)r=l[o],t[r]&&(p.copy(t[r]),p.add(i),t[r]=p,s=!0);s&&t.update()}};var SomVideoTextureManager=pc.createScript("_som_videoTextureManager");SomVideoTextureManager.attributes.add("throttle",{title:"Optimize Performance",type:"boolean",description:"When enabled, no more than 1 video texture will update per-engine-frame.",default:!0}),SomVideoTextureManager.attributes.add("videos",{title:"Videos",type:"json",schema:[{title:"Material Asset",name:"material",type:"asset",assetType:"material"},{title:"Video Asset",name:"asset",type:"asset",description:"Use an MP4 video asset OR a URL, not both."},{title:"Video URL",name:"url",type:"string",description:"Use an MP4 video asset OR a URL, not both."},{title:"Diffuse",name:"diffuse",type:"boolean",default:!1},{title:"Emissive",name:"emissive",type:"boolean",default:!0}],array:!0}),SomVideoTextureManager.prototype.initialize=function(){const e=this.app;this.updateIndex=-1,this.runningVideos=[];for(let i=0;i<this.videos.length;i++){let s=this.videos[i],n={};var t=document.createElement("video");t.loop=!0,t.muted=!0,t.playsInline=!0,t.crossOrigin="anonymous",t.autoplay=!0,t.style.cssText="width: 1px; height: 1px; position: absolute; opacity: 0; z-index: -1000; pointer-events: none;",document.body.appendChild(t);let a=new pc.Texture(e.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8,minFilter:pc.FILTER_LINEAR_MIPMAP_LINEAR,magFilter:pc.FILTER_LINEAR,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE,mipmaps:!0});a.setSource(t),t.addEventListener("canplaythrough",function(e){this.entry.emissive&&(this.entry.material.resource.emissiveMap=this.texture),this.entry.diffuse&&(this.entry.material.resource.diffuseMap=this.texture),this.entry.material.resource.update(),t.play()}.bind(n)),t.src=s.asset?s.asset.getFileUrl():s.url,document.body.appendChild(t),t.load(),n.entry=s,n.video=t,n.texture=a,this.runningVideos.push(n)}},SomVideoTextureManager.prototype.update=function(e){if(this.runningVideos.length>0)if(this.throttle){this.updateIndex++,this.updateIndex>=this.runningVideos.length&&(this.updateIndex=0);let e=this.runningVideos[this.updateIndex];e.video;const isVideoPlaying=e=>!!(e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2);isVideoPlaying&&e.texture.upload()}else for(let e=0;e<this.runningVideos.length;e++){let t=this.runningVideos[e];t.video;const isVideoPlaying=e=>!!(e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2);isVideoPlaying&&t.texture.upload()}};var SomRemoteImageLoader=pc.createScript("_som_remoteImageLoader");SomRemoteImageLoader.attributes.add("images",{title:"Images",type:"json",schema:[{title:"Material Asset",name:"material",type:"asset",assetType:"material"},{title:"Image URL",name:"url",type:"string"},{title:"Diffuse",name:"diffuse",type:"boolean",default:!0},{title:"Emissive",name:"emissive",type:"boolean",default:!0},{title:"Use Transparency",name:"transparent",type:"boolean",default:!1}],array:!0}),SomRemoteImageLoader.prototype.initialize=function(){let e;this.app;for(let t=0;t<this.images.length;t++){if(e=this.images[t],!e.url)continue;this.app.loader.getHandler("texture").crossOrigin="anonymous";let a=new pc.Asset("remoteTexture","texture",{url:e.url});this.app.assets.add(a),a.on("error",(function(e){console.log(e)})),a.on("load",function(e){this.emissive&&(this.material.resource.emissiveMap=e.resource),this.diffuse&&(this.material.resource.diffuseMap=e.resource),this.transparent&&(this.material.resource.blendType=pc.BLEND_NORMAL,this.material.resource.opacityMapChannel="a",this.material.resource.opacityMap=e.resource),this.material.resource.update()}.bind(e)),this.app.assets.load(a)}};